{% comment %}
  Product Card Snippet
  Usage: {% render 'product-card', product: product %}
{% endcomment %}

{% assign all_variants_unavailable = true %}
{% assign has_discount = false %}
{% assign compare_price = product.compare_at_price_min %}
{% assign current_price = product.price_min %}

{% if product.compare_at_price_min > product.price_min %}
  {% assign has_discount = true %}
{% elsif product.variants.size > 0 %}
  {% for variant in product.variants %}
    {% if variant.compare_at_price > variant.price %}
      {% assign has_discount = true %}
      {% assign compare_price = variant.compare_at_price %}
      {% assign current_price = variant.price %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% for variant in product.variants %}
  {% if variant.available %}
    {% assign all_variants_unavailable = false %}
    {% break %}
  {% endif %}
{% endfor %}

<div class="product-card">
  <a href="{{ product.url }}" class="product-link{% if product.images.size > 1 %} product-link--has-multiple-images{% endif %}">
    {% if product.featured_image %}
      <div class="product-image-wrapper">
        {% if all_variants_unavailable %}
          <div class="product-sold-out-badge">SOLD OUT</div>
        {% endif %}
        <img
          width="493"
          height="616"
          src="{{ product.featured_image | img_url: '493x616' }}"
          alt="{{ product.featured_image.alt | escape }}"
          class="product-image product-image--primary"
          loading="lazy">
        {% if product.images.size > 1 %}
          <img
            width="493"
            height="616"
            src="{{ product.images[1] | img_url: '493x616' }}"
            alt="{{ product.images[1].alt | escape }}"
            class="product-image product-image--secondary"
            loading="lazy">
        {% endif %}
      </div>
    {% endif %}
    <div class="product-info">
      <div class="product-title-price">
        <h2 class="product-title">{{ product.title }}{% if product.metafields.custom.pre_order_mode %} - Pre-order{% endif %}</h2>
        <div class="product-price">
          {% if has_discount %}
            <span class="product-price-old">{{ compare_price | money }}</span>
            <span class="product-price-new">{{ current_price | money }}</span>
          {% else %}
            {{ product.price_min | money }}
          {% endif %}
        </div>
      </div>
      {% if product.variants.size > 0 %}
        {% comment %} Get unique sizes by checking each size individually {% endcomment %}
        {% assign unique_sizes_list = '' %}
        {% for variant in product.variants %}
          {% assign current_size = variant.option1 %}
          {% assign size_exists = false %}
          
          {% comment %} Check if this size already exists in our list {% endcomment %}
          {% if unique_sizes_list != '' %}
            {% assign existing_sizes = unique_sizes_list | split: '|||' %}
            {% for existing_size in existing_sizes %}
              {% if existing_size == current_size %}
                {% assign size_exists = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% comment %} Add size if it doesn't exist {% endcomment %}
          {% unless size_exists %}
            {% if unique_sizes_list == '' %}
              {% assign unique_sizes_list = current_size %}
            {% else %}
              {% assign unique_sizes_list = unique_sizes_list | append: '|||' | append: current_size %}
            {% endif %}
          {% endunless %}
        {% endfor %}
        
        {% comment %} Display unique sizes with availability {% endcomment %}
        {% if unique_sizes_list != '' %}
          <ul class="product-sizes">
            {% assign sizes_array = unique_sizes_list | split: '|||' %}
            {% for size in sizes_array %}
              {% assign size_available = false %}
              {% for variant in product.variants %}
                {% if variant.option1 == size and variant.available %}
                  {% assign size_available = true %}
                  {% break %}
                {% endif %}
              {% endfor %}
              <li class="product-size{% if size_available %} product-size--available{% else %} product-size--unavailable{% endif %}">
                {{ size }}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endif %}
    </div>
  </a>
</div>

